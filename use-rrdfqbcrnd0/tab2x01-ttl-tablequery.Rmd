--
title: "Create TAB1X02_1 as RDF data cube"
author: "mja@statgroup.dk"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    theme: united
  pdf_document:
    toc: true
    highlight: zenburn
  md_document:
    variant: markdown_github
---

# Introduction
This script creates RDF data cubes from .csv files.

# Setup

All files are stored in the directory
```{r}
targetName<- "TAB2X01"
(targetName)
targetDir<- "../res-ttl"
(targetDir)
targetFile<- file.path(targetDir, paste("CDISC-pilot-", targetName, ".ttl", sep=""))
(targetFile)
targetObsrqFile<- file.path(targetDir, paste("CDISC-pilot-", targetName, "-observations", ".rq", sep=""))
(targetObsrqFile)
```

```{r, child='include_ttl.Rmd'}
```

```{r}

z12prop<- matrix(c(
"code:procedure-min", "code:none",
"code:procedure-max", "code:none",
"code:procedure-median", "code:none",
"code:procedure-mean", "code:none",
"code:procedure-stddev", "code:none",
"code:procedure-n ", "code:procedure-percent",
"code:procedure-count", "code:none"
    ), ncol=2,byrow=TRUE)
str(z12prop)
z12prop

rowdimensions<-c(
"crnd-dimension:agegr1"   ,
"crnd-dimension:race"     ,
"crnd-dimension:sex"      ,
"crnd-dimension:durdsgr1" ,
"crnd-dimension:bmiblgr1" ,
"crnd-dimension:ittfl"    ,
"crnd-dimension:procedure",
"crnd-dimension:factor"
    )

coldimension<- c("crnd-dimension:trt01p"   )

contvarstat<-
c("factor-age",
"factor-mmsetot", 
"factor-durdis",  
"factor-educlvl", 
"factor-heightbl",
"factor-weightbl",
"factor-bmibl"
)
    
contvarstatprocedure<-
c("code:procedure-percent",
"code:procedure-count"
)
    
catvardimensions1<-
    c(
"crnd-dimension:agegr1"   ,
"crnd-dimension:race"     ,
"crnd-dimension:sex"      ,
"crnd-dimension:durdsgr1" ,
"crnd-dimension:bmiblgr1" ,
"crnd-dimension:ittfl"    
        )


cube.rowdimscont.rq<-
    paste( forsparqlprefix,
          paste0( "select distinct ", paste0(sub("crnd-dimension:", "?", rowdimensions ), collapse=" "), " where {", collapse="\n"),
          "?s a qb:Observation  ;", 
          paste0( "    ", "qb:dataSet",  " ", "ds:", "dataset", "-", domainName, " ;", collapse="\n"),
          paste0( "    ", rowdimensions, " ", sub("crnd-dimension:", "?", rowdimensions ), ";", collapse="\n"),
          "    crnd-dimension:procedure ?procedure ; ",
          "    crnd-dimension:factor ?factor .      ",
          "     values (?factor) {",
          paste0( "     ", "(", "code:", contvarstat, ")", collapse="\n"),
          "}",
          "} ",
          "order by ?s",
          "\n",
          sep="\n", collapse="\n"
          )
cat(cube.rowdims.rq)

observationsRowDims<- as.data.frame(sparql.rdf(checkCube, cube.rowdims.rq ), stringsAsFactors=FALSE)
knitr::kable(observationsRowDims)

cube.rowdimscat.rq<-
    paste( forsparqlprefix,
          paste0( "select distinct ", paste0(sub("crnd-dimension:", "?", rowdimensions ), collapse=" "), " where {", collapse="\n"),
          "?s a qb:Observation  ;", 
          paste0( "    ", "qb:dataSet",  " ", "ds:", "dataset", "-", domainName, " ;", collapse="\n"),
          paste0( "    ", catvardimensions1, " ", sub("crnd-dimension:", "?", catvardimensions1 ), ";", collapse="\n"),
          "    crnd-dimension:procedure ?procedure ; ",
          "    crnd-dimension:factor ?factor .      ",
          "     values (?procedure) {",
          paste0( "     ", "(", contvarstatprocedure, ")", collapse="\n"),
          "}",
          "} ",
          "order by ?s",
          "\n",
          sep="\n", collapse="\n"
          )
cat(cube.rowdimscat.rq)

observationsRowDimsCat<- as.data.frame(sparql.rdf(checkCube, cube.rowdimscat.rq ), stringsAsFactors=FALSE)
knitr::kable(observationsRowDimsCat)

## make select unition combining observationsRowDims observationsRowDimsCat

```


